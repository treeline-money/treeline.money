---
import BaseLayout from "../layouts/BaseLayout.astro";
import ThemedImage from "../components/ThemedImage.astro";
import { plugins } from "../data/plugins";
---

<BaseLayout title="treeline">
  <!-- Hero -->
  <section class="hero max-w-3xl mx-auto px-6 pt-16 sm:pt-24 pb-16">
    <div class="flex items-center gap-4 mb-6">
      <!-- Light theme logo -->
      <svg class="hero-logo logo-light" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 12 L20 35 L35 40 L44 35 Z" fill="#f5f5f4"/>
        <path d="M20 35 L35 40 L44 35 L54 52 L10 52 Z" fill="#4a8a63"/>
        <path d="M32 12 L54 52 L10 52 Z" stroke="#4a8a63" stroke-width="2.5" fill="none"/>
      </svg>
      <!-- Dark theme logo -->
      <svg class="hero-logo logo-dark" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 12 L20 35 L35 40 L44 35 Z" fill="#ffffff"/>
        <path d="M20 35 L35 40 L44 35 L54 52 L10 52 Z" fill="#6aaa83"/>
        <path d="M32 12 L54 52 L10 52 Z" stroke="#6aaa83" stroke-width="2.5" fill="none"/>
      </svg>
      <h1 class="text-4xl sm:text-5xl font-semibold">treeline</h1>
    </div>
    <p class="tagline text-2xl sm:text-3xl text-[var(--color-text)] font-medium mb-4">
      Personal finance should be personal.
    </p>
    <p class="text-lg text-[var(--color-text-muted)]">
      A local-first, plugin-based finance app that grows with you.
    </p>

    <!-- Scroll indicator - fades out once user scrolls -->
    <div class="scroll-indicator" id="scroll-indicator">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M7 10l5 5 5-5"/>
      </svg>
    </div>
  </section>

  <script>
    // Hide scroll indicator after user scrolls
    const indicator = document.getElementById('scroll-indicator');
    let hidden = false;

    window.addEventListener('scroll', () => {
      if (!hidden && window.scrollY > 50) {
        hidden = true;
        indicator?.style.setProperty('opacity', '0');
      }
    }, { passive: true });
  </script>

  <!-- Manifesto - The focal point -->
  <section class="max-w-3xl mx-auto px-6 pb-20">
    <div class="prose text-lg leading-relaxed space-y-6 text-[var(--color-text-muted)]">
      <p>
        I've had many distinct seasons in my adult life, and each one brings a fresh
        perspective for how I think about money. Early on, I cared deeply about sticking
        to a tight budget. Now, I'm more interested in long-term planning and exploring
        different "what-if" scenarios. The highly custom spreadsheet I built when I was
        22 is simply insufficient for the way I view money at 33.
      </p>

      <p>
        I tried a few different finance apps and, while they brought convenience, they
        all lacked <em>something</em>—because the way I wanted to view my money didn't
        perfectly match The App's opinion of how I was <em>supposed</em> to view my money.
      </p>

      <p>
        I want to tinker. I want to ask questions of my data that no product manager
        anticipated. I want my tools to grow with me as my needs change.
      </p>

      <p>
        So I built Treeline.
      </p>

      <div class="flex flex-wrap items-center gap-4 pt-2">
        <a
          href="/download"
          class="px-5 py-2.5 bg-[var(--color-accent)] text-white font-medium rounded-md hover:bg-[var(--color-accent-muted)] transition-colors"
        >
          Download
        </a>
        <a href="/blog/manifesto" class="text-[var(--color-text)]">Keep reading →</a>
      </div>
    </div>
  </section>

  <!-- Screenshots: Accounts -->
  <section class="max-w-5xl mx-auto px-6 pb-16">
    <button class="screenshot-btn" data-light="/screenshots/accounts-light.png" data-dark="/screenshots/accounts-dark.png" aria-label="View screenshot full size">
      <ThemedImage
        light="/screenshots/accounts-light.png"
        dark="/screenshots/accounts-dark.png"
        alt="Treeline accounts view showing account balances"
        class="rounded-lg border border-[var(--color-border)] shadow-lg"
      />
      <span class="screenshot-hint">Tap to expand</span>
    </button>
  </section>

  <!-- Screenshots: Transactions -->
  <section class="max-w-5xl mx-auto px-6 pb-20">
    <h2 class="text-xl font-semibold mb-4 text-center">Smart transaction management</h2>
    <p class="text-[var(--color-text-muted)] text-center mb-8 max-w-2xl mx-auto">
      Tag transactions with a keystroke. Set up rules to categorize automatically.
      Split transactions, hide duplicates, search across everything.
    </p>
    <div class="screenshots-stack">
      <!-- Transactions video -->
      <button class="screenshot-btn video-btn" data-video-light="/screenshots/transactions-light.mov" data-video-dark="/screenshots/transactions-dark.mov" aria-label="View video full size">
        <div class="screenshot-video-wrapper">
          <video
            class="screenshot-video video-light"
            autoplay
            loop
            muted
            playsinline
          >
            <source src="/screenshots/transactions-light.mov" type="video/mp4" />
          </video>
          <video
            class="screenshot-video video-dark"
            autoplay
            loop
            muted
            playsinline
          >
            <source src="/screenshots/transactions-dark.mov" type="video/mp4" />
          </video>
        </div>
        <span class="screenshot-hint">Tap to expand</span>
      </button>
      <!-- Rules screenshot -->
      <button class="screenshot-btn" data-light="/screenshots/rules-light.png" data-dark="/screenshots/rules-dark.png" aria-label="View screenshot full size">
        <ThemedImage
          light="/screenshots/rules-light.png"
          dark="/screenshots/rules-dark.png"
          alt="Treeline tagging rules modal"
          class="rounded-lg shadow-sm"
        />
        <span class="screenshot-hint">Tap to expand</span>
      </button>
    </div>
  </section>

  <!-- What you get - Simple list -->
  <section class="border-t border-[var(--color-border)] bg-[var(--color-bg-secondary)]">
    <div class="max-w-3xl mx-auto px-6 py-20">
      <h2 class="text-xl font-semibold mb-8">What you get</h2>

      <ul class="space-y-4 text-[var(--color-text-muted)]">
        <li>A desktop app for Mac, Windows, and Linux</li>
        <li>Your data in a local DuckDB database</li>
        <li>Bank sync via SimpleFIN, or CSV import</li>
        <li>Quick tagging with customizable rules</li>
        <li>A plugin system for extending functionality</li>
        <li>Optional database encryption</li>
        <li>No account required, no subscription</li>
      </ul>
    </div>
  </section>

  <!-- Plugins -->
  <section class="border-t border-[var(--color-border)]" id="plugins">
    <div class="max-w-4xl mx-auto px-6 py-20">
      <h2 class="text-xl font-semibold mb-4">Plugins</h2>
      <p class="text-[var(--color-text-muted)] mb-8">
        Core features like Budget and Accounts are plugins. Community plugins add
        subscription tracking, savings goals, cash flow projections, and more. Or
        build exactly what you need—the SDK gives you full access to your data.
      </p>

      <!-- Plugin Grid -->
      <div class="plugins-grid">
        {plugins.map(plugin => (
          <a href={`/plugins/${plugin.id}`} class="plugin-card">
            <h3 class="plugin-card-title">{plugin.name}</h3>
            <p class="plugin-card-description">{plugin.description}</p>
          </a>
        ))}
      </div>

      <div class="mt-8 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm">
        <a href="/plugins" class="text-[var(--color-accent)] font-medium">
          Browse all community plugins →
        </a>
        <span class="text-[var(--color-text-muted)]">
          or
          <a href="https://github.com/treeline-money/treeline" class="text-[var(--color-accent)]" target="_blank" rel="noopener noreferrer">
            build your own
          </a>
        </span>
      </div>
    </div>
  </section>

  <!-- Go deeper: SQL -->
  <section class="border-t border-[var(--color-border)] bg-[var(--color-bg-secondary)]">
    <div class="max-w-4xl mx-auto px-6 py-20">
      <h2 class="text-xl font-semibold mb-4">Go deeper</h2>
      <p class="text-[var(--color-text-muted)] mb-8">
        Your data is a standard DuckDB file. When you want to ask questions no app anticipated,
        use the built-in SQL editor—or query directly from the terminal, a Jupyter notebook,
        or any tool that speaks SQL.
      </p>
      <div class="query-example">
        <div class="query-code">
          <pre><code><span class="sql-keyword">SELECT</span>
  <span class="sql-func">dayname</span>(transaction_date) <span class="sql-keyword">AS</span> day,
  <span class="sql-func">COUNT</span>(*) <span class="sql-keyword">AS</span> transactions,
  <span class="sql-func">SUM</span>(-amount) <span class="sql-keyword">AS</span> total_spent
<span class="sql-keyword">FROM</span> transactions
<span class="sql-keyword">WHERE</span> amount &lt; 0
<span class="sql-keyword">GROUP BY</span> <span class="sql-func">dayofweek</span>(transaction_date), day
<span class="sql-keyword">ORDER BY</span> <span class="sql-func">dayofweek</span>(transaction_date)</code></pre>
        </div>
        <div class="query-results">
          <table>
            <thead>
              <tr>
                <th>day</th>
                <th>transactions</th>
                <th>total_spent</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Sunday</td><td>47</td><td>$312.84</td></tr>
              <tr><td>Monday</td><td>89</td><td>$567.23</td></tr>
              <tr><td>Tuesday</td><td>72</td><td>$445.91</td></tr>
              <tr><td>Wednesday</td><td>68</td><td>$398.45</td></tr>
              <tr><td>Thursday</td><td>81</td><td>$523.67</td></tr>
              <tr><td>Friday</td><td>124</td><td>$891.32</td></tr>
              <tr><td>Saturday</td><td>95</td><td>$634.18</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Get treeline -->
  <section class="border-t border-[var(--color-border)]">
    <div class="max-w-3xl mx-auto px-6 py-20">
      <h2 class="text-xl font-semibold mb-4">Get treeline</h2>
      <p class="text-[var(--color-text-muted)] mb-8">
        treeline is in beta. Download the app and join Discord to share feedback.
      </p>
      <div class="flex flex-wrap gap-4">
        <a
          href="/download"
          class="px-5 py-2.5 bg-[var(--color-accent)] text-white font-medium rounded-md hover:bg-[var(--color-accent-muted)] transition-colors"
        >
          Download
        </a>
        <a
          href="https://discord.gg/EcNvBnSft5"
          class="px-5 py-2.5 border border-[var(--color-border)] text-[var(--color-text)] font-medium rounded-md hover:border-[var(--color-text-muted)] transition-colors"
        >
          Join Discord
        </a>
      </div>
    </div>
  </section>

  <!-- Lightbox for screenshots and videos -->
  <div id="screenshot-lightbox" class="lightbox" aria-hidden="true">
    <button class="lightbox-close" aria-label="Close">&times;</button>
    <img class="lightbox-img" src="" alt="Screenshot expanded view" />
    <video class="lightbox-video" autoplay loop muted playsinline>
      <source src="" type="video/mp4" />
    </video>
  </div>
</BaseLayout>

<style>
  .hero {
    min-height: calc(100vh - 80px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
  }

  .hero-logo {
    width: 56px;
    height: 56px;
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .hero-logo {
      width: 72px;
      height: 72px;
    }
  }

  .tagline {
    letter-spacing: -0.02em;
  }

  .scroll-indicator {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    color: var(--color-text-muted);
    opacity: 0.4;
    transition: opacity 0.4s ease;
    animation: gentle-bounce 3s ease-in-out infinite;
  }

  @keyframes gentle-bounce {
    0%, 100% {
      transform: translateX(-50%) translateY(0);
    }
    50% {
      transform: translateX(-50%) translateY(6px);
    }
  }

  /* Screenshot buttons */
  .screenshot-btn {
    display: block;
    width: 100%;
    padding: 0;
    margin: 0;
    background: none;
    border: none;
    cursor: pointer;
    position: relative;
  }

  .screenshot-btn + .screenshot-btn {
    margin-top: 3rem;
  }

  /* Screenshots grid */
  .screenshots-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .screenshots-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  /* Screenshots stack - always stacked vertically */
  .screenshots-stack {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .screenshots-stack > .screenshot-btn {
    margin: 0;
    padding: 0;
  }

  .screenshots-stack .screenshot-video-wrapper {
    width: 100%;
  }

  .screenshots-stack .screenshot-video {
    width: 100%;
    height: auto;
  }

  .screenshots-stack :global(img) {
    width: 100%;
    height: auto;
  }

  /* Query example */
  .query-example {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
  }

  .query-code {
    padding: 1.5rem;
    border-bottom: 1px solid var(--color-border);
    overflow-x: auto;
  }

  .query-code pre {
    margin: 0;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--color-text);
  }

  .query-code code {
    font-family: inherit;
  }

  .sql-keyword {
    color: var(--color-accent);
    font-weight: 600;
  }

  .sql-func {
    color: #a78bfa;
  }

  :root.dark .sql-func {
    color: #c4b5fd;
  }

  .query-results {
    padding: 1rem 1.5rem;
    overflow-x: auto;
  }

  .query-results table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .query-results th,
  .query-results td {
    padding: 0.5rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .query-results th {
    font-weight: 600;
    color: var(--color-text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .query-results td {
    color: var(--color-text);
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
  }

  .query-results tbody tr:last-child td {
    border-bottom: none;
  }

  .query-results tbody tr:nth-child(6) td { /* Friday row */
    color: var(--color-accent);
    font-weight: 600;
  }

  .query-caption {
    padding: 1rem 1.5rem;
    margin: 0;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-style: italic;
    text-align: center;
    border-top: 1px solid var(--color-border);
    background: var(--color-bg);
  }

  .screenshot-btn :global(img) {
    width: 100%;
    height: auto;
    transition: transform 0.2s ease;
    vertical-align: top;
  }

  .screenshot-btn .screenshot-video-wrapper {
    vertical-align: top;
  }

  .screenshot-hint {
    display: none;
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .screenshot-hint {
      display: block;
    }
  }

  /* Lightbox */
  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 100;
    background: rgba(0, 0, 0, 0.9);
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .lightbox.active {
    display: flex;
  }

  .lightbox-img,
  .lightbox-video {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
  }

  .lightbox-img { display: block; }
  .lightbox-video { display: none; }
  .lightbox.video-mode .lightbox-img { display: none; }
  .lightbox.video-mode .lightbox-video { display: block; }

  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 2rem;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Themed video */
  .screenshot-video-wrapper {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .screenshot-video {
    width: 100%;
    height: auto;
    display: block;
    margin: 0;
    padding: 0;
  }

  .video-light { display: block; }
  .video-dark { display: none; }
  :root.dark .video-light { display: none; }
  :root.dark .video-dark { display: block; }

  /* Ensure video button aligns with image button */
  .video-btn .screenshot-video-wrapper {
    margin: 0;
  }

  .screenshot-placeholder {
    background: var(--color-bg-secondary);
    border: 2px dashed var(--color-border);
    border-radius: 8px;
    padding: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    min-height: 350px;
  }

  .screenshot-placeholder-small {
    min-height: 200px;
    flex-direction: column;
    gap: 0.5rem;
  }

  .screenshot-placeholder-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    max-width: 600px;
  }

  .screenshot-label {
    color: var(--color-text-muted);
    font-size: 14px;
    font-style: italic;
  }

  .screenshot-description {
    color: var(--color-text-muted);
    font-size: 13px;
    margin: 0;
  }

  .screenshot-query {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 1rem;
    font-size: 12px;
    text-align: left;
    color: var(--color-text);
    overflow-x: auto;
    width: 100%;
  }

  .screenshot-note {
    color: var(--color-text-muted);
    font-size: 12px;
    margin: 0;
    font-style: italic;
  }

  /* Plugins Grid */
  .plugins-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
  }

  .plugin-card {
    display: block;
    text-decoration: none;
    padding: 1.25rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }

  .plugin-card:hover {
    border-color: var(--color-accent);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .plugin-card-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-text);
  }

  .plugin-card-description {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    line-height: 1.5;
  }
</style>

<script>
  // Lightbox functionality
  const lightbox = document.getElementById('screenshot-lightbox');
  const lightboxImg = lightbox?.querySelector('.lightbox-img') as HTMLImageElement;
  const lightboxVideo = lightbox?.querySelector('.lightbox-video') as HTMLVideoElement;
  const lightboxVideoSource = lightboxVideo?.querySelector('source') as HTMLSourceElement;
  const lightboxClose = lightbox?.querySelector('.lightbox-close');
  const screenshotBtns = document.querySelectorAll('.screenshot-btn');

  function openImageLightbox(lightSrc: string, darkSrc: string) {
    if (!lightbox || !lightboxImg) return;
    const isDark = document.documentElement.classList.contains('dark');
    lightboxImg.src = isDark ? darkSrc : lightSrc;
    lightbox.classList.remove('video-mode');
    lightbox.classList.add('active');
    lightbox.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function openVideoLightbox(lightSrc: string, darkSrc: string) {
    if (!lightbox || !lightboxVideo || !lightboxVideoSource) return;
    const isDark = document.documentElement.classList.contains('dark');
    lightboxVideoSource.src = isDark ? darkSrc : lightSrc;
    lightboxVideo.load();
    lightboxVideo.play();
    lightbox.classList.add('video-mode', 'active');
    lightbox.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    if (!lightbox) return;
    lightbox.classList.remove('active', 'video-mode');
    lightbox.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    if (lightboxVideo) {
      lightboxVideo.pause();
    }
  }

  screenshotBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const videoLight = btn.getAttribute('data-video-light');
      const videoDark = btn.getAttribute('data-video-dark');

      if (videoLight && videoDark) {
        openVideoLightbox(videoLight, videoDark);
      } else {
        const light = btn.getAttribute('data-light') || '';
        const dark = btn.getAttribute('data-dark') || '';
        openImageLightbox(light, dark);
      }
    });
  });

  lightboxClose?.addEventListener('click', closeLightbox);
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
  });
</script>
